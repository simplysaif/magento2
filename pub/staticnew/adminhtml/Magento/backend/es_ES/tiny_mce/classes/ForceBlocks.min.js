(function(tinymce){var Event=tinymce.dom.Event,isIE=tinymce.isIE,isGecko=tinymce.isGecko,isOpera=tinymce.isOpera,each=tinymce.each,extend=tinymce.extend,TRUE=true,FALSE=false;function cloneFormats(node){var clone,temp,inner;do{if(/^(SPAN|STRONG|B|EM|I|FONT|STRIKE|U)$/.test(node.nodeName)){if(clone){temp=node.cloneNode(false);temp.appendChild(clone);clone=temp;}else{clone=inner=node.cloneNode(false);}
clone.removeAttribute('id');}}while(node=node.parentNode);if(clone)
return{wrapper:clone,inner:inner};};function isAtEnd(rng,par){var rng2=par.ownerDocument.createRange();rng2.setStart(rng.endContainer,rng.endOffset);rng2.setEndAfter(par);return rng2.cloneContents().textContent.length==0;};function splitList(selection,dom,li){var listBlock,block;if(dom.isEmpty(li)){listBlock=dom.getParent(li,'ul,ol');if(!dom.getParent(listBlock.parentNode,'ul,ol')){dom.split(listBlock,li);block=dom.create('p',0,'<br data-mce-bogus="1" />');dom.replace(block,li);selection.select(block,1);}
return FALSE;}
return TRUE;};tinymce.create('tinymce.ForceBlocks',{ForceBlocks:function(ed){var t=this,s=ed.settings,elm;t.editor=ed;t.dom=ed.dom;elm=(s.forced_root_block||'p').toLowerCase();s.element=elm.toUpperCase();ed.onPreInit.add(t.setup,t);},setup:function(){var t=this,ed=t.editor,s=ed.settings,dom=ed.dom,selection=ed.selection,blockElements=ed.schema.getBlockElements();if(s.forced_root_block){function addRootBlocks(){var node=selection.getStart(),rootNode=ed.getBody(),rng,startContainer,startOffset,endContainer,endOffset,rootBlockNode,tempNode,offset=-0xFFFFFF;if(!node||node.nodeType!==1)
return;while(node!=rootNode){if(blockElements[node.nodeName])
return;node=node.parentNode;}
rng=selection.getRng();if(rng.setStart){startContainer=rng.startContainer;startOffset=rng.startOffset;endContainer=rng.endContainer;endOffset=rng.endOffset;}else{if(rng.item){rng=ed.getDoc().body.createTextRange();rng.moveToElementText(rng.item(0));}
tmpRng=rng.duplicate();tmpRng.collapse(true);startOffset=tmpRng.move('character',offset)*-1;if(!tmpRng.collapsed){tmpRng=rng.duplicate();tmpRng.collapse(false);endOffset=(tmpRng.move('character',offset)*-1)-startOffset;}}
for(node=rootNode.firstChild;node;node){if(node.nodeType===3||(node.nodeType==1&&!blockElements[node.nodeName])){if(!rootBlockNode){rootBlockNode=dom.create(s.forced_root_block);node.parentNode.insertBefore(rootBlockNode,node);}
tempNode=node;node=node.nextSibling;rootBlockNode.appendChild(tempNode);}else{rootBlockNode=null;node=node.nextSibling;}}
if(rng.setStart){rng.setStart(startContainer,startOffset);rng.setEnd(endContainer,endOffset);selection.setRng(rng);}else{try{rng=ed.getDoc().body.createTextRange();rng.moveToElementText(rootNode);rng.collapse(true);rng.moveStart('character',startOffset);if(endOffset>0)
rng.moveEnd('character',endOffset);rng.select();}catch(ex){}}
ed.nodeChanged();};ed.onKeyUp.add(addRootBlocks);ed.onClick.add(addRootBlocks);}
if(s.force_br_newlines){if(isIE){ed.onKeyPress.add(function(ed,e){var n;if(e.keyCode==13&&selection.getNode().nodeName!='LI'){selection.setContent('<br id="__" /> ',{format:'raw'});n=dom.get('__');n.removeAttribute('id');selection.select(n);selection.collapse();return Event.cancel(e);}});}}
if(s.force_p_newlines){if(!isIE){ed.onKeyPress.add(function(ed,e){if(e.keyCode==13&&!e.shiftKey&&!t.insertPara(e))
Event.cancel(e);});}else{tinymce.addUnload(function(){t._previousFormats=0;});ed.onKeyPress.add(function(ed,e){t._previousFormats=0;if(e.keyCode==13&&!e.shiftKey&&ed.selection.isCollapsed()&&s.keep_styles)
t._previousFormats=cloneFormats(ed.selection.getStart());});ed.onKeyUp.add(function(ed,e){if(e.keyCode==13&&!e.shiftKey){var parent=ed.selection.getStart(),fmt=t._previousFormats;if(!parent.hasChildNodes()&&fmt){parent=dom.getParent(parent,dom.isBlock);if(parent&&parent.nodeName!='LI'){parent.innerHTML='';if(t._previousFormats){parent.appendChild(fmt.wrapper);fmt.inner.innerHTML='\uFEFF';}else
parent.innerHTML='\uFEFF';selection.select(parent,1);selection.collapse(true);ed.getDoc().execCommand('Delete',false,null);t._previousFormats=0;}}}});}
if(isGecko){ed.onKeyDown.add(function(ed,e){if((e.keyCode==8||e.keyCode==46)&&!e.shiftKey)
t.backspaceDelete(e,e.keyCode==8);});}}
if(tinymce.isWebKit){function insertBr(ed){var rng=selection.getRng(),br,div=dom.create('div',null,' '),divYPos,vpHeight=dom.getViewPort(ed.getWin()).h;rng.insertNode(br=dom.create('br'));rng.setStartAfter(br);rng.setEndAfter(br);selection.setRng(rng);if(selection.getSel().focusNode==br.previousSibling){selection.select(dom.insertAfter(dom.doc.createTextNode('\u00a0'),br));selection.collapse(TRUE);}
dom.insertAfter(div,br);divYPos=dom.getPos(div).y;dom.remove(div);if(divYPos>vpHeight)
ed.getWin().scrollTo(0,divYPos);};ed.onKeyPress.add(function(ed,e){if(e.keyCode==13&&(e.shiftKey||(s.force_br_newlines&&!dom.getParent(selection.getNode(),'h1,h2,h3,h4,h5,h6,ol,ul')))){insertBr(ed);Event.cancel(e);}});}
if(isIE){if(s.element!='P'){ed.onKeyPress.add(function(ed,e){t.lastElm=selection.getNode().nodeName;});ed.onKeyUp.add(function(ed,e){var bl,n=selection.getNode(),b=ed.getBody();if(b.childNodes.length===1&&n.nodeName=='P'){n=dom.rename(n,s.element);selection.select(n);selection.collapse();ed.nodeChanged();}else if(e.keyCode==13&&!e.shiftKey&&t.lastElm!='P'){bl=dom.getParent(n,'p');if(bl){dom.rename(bl,s.element);ed.nodeChanged();}}});}}},getParentBlock:function(n){var d=this.dom;return d.getParent(n,d.isBlock);},insertPara:function(e){var t=this,ed=t.editor,dom=ed.dom,d=ed.getDoc(),se=ed.settings,s=ed.selection.getSel(),r=s.getRangeAt(0),b=d.body;var rb,ra,dir,sn,so,en,eo,sb,eb,bn,bef,aft,sc,ec,n,vp=dom.getViewPort(ed.getWin()),y,ch,car;ed.undoManager.beforeChange();rb=d.createRange();rb.setStart(s.anchorNode,s.anchorOffset);rb.collapse(TRUE);ra=d.createRange();ra.setStart(s.focusNode,s.focusOffset);ra.collapse(TRUE);dir=rb.compareBoundaryPoints(rb.START_TO_END,ra)<0;sn=dir?s.anchorNode:s.focusNode;so=dir?s.anchorOffset:s.focusOffset;en=dir?s.focusNode:s.anchorNode;eo=dir?s.focusOffset:s.anchorOffset;if(sn===en&&/^(TD|TH)$/.test(sn.nodeName)){if(sn.firstChild.nodeName=='BR')
dom.remove(sn.firstChild);if(sn.childNodes.length==0){ed.dom.add(sn,se.element,null,'<br />');aft=ed.dom.add(sn,se.element,null,'<br />');}else{n=sn.innerHTML;sn.innerHTML='';ed.dom.add(sn,se.element,null,n);aft=ed.dom.add(sn,se.element,null,'<br />');}
r=d.createRange();r.selectNodeContents(aft);r.collapse(1);ed.selection.setRng(r);return FALSE;}
if(sn==b&&en==b&&b.firstChild&&ed.dom.isBlock(b.firstChild)){sn=en=sn.firstChild;so=eo=0;rb=d.createRange();rb.setStart(sn,0);ra=d.createRange();ra.setStart(en,0);}
if(!d.body.hasChildNodes()){d.body.appendChild(dom.create('br'));}
sn=sn.nodeName=="HTML"?d.body:sn;sn=sn.nodeName=="BODY"?sn.firstChild:sn;en=en.nodeName=="HTML"?d.body:en;en=en.nodeName=="BODY"?en.firstChild:en;sb=t.getParentBlock(sn);eb=t.getParentBlock(en);bn=sb?sb.nodeName:se.element;if(n=t.dom.getParent(sb,'li,pre')){if(n.nodeName=='LI')
return splitList(ed.selection,t.dom,n);return TRUE;}
if(sb&&(sb.nodeName=='CAPTION'||/absolute|relative|fixed/gi.test(dom.getStyle(sb,'position',1)))){bn=se.element;sb=null;}
if(eb&&(eb.nodeName=='CAPTION'||/absolute|relative|fixed/gi.test(dom.getStyle(sb,'position',1)))){bn=se.element;eb=null;}
if(/(TD|TABLE|TH|CAPTION)/.test(bn)||(sb&&bn=="DIV"&&/left|right/gi.test(dom.getStyle(sb,'float',1)))){bn=se.element;sb=eb=null;}
bef=(sb&&sb.nodeName==bn)?sb.cloneNode(0):ed.dom.create(bn);aft=(eb&&eb.nodeName==bn)?eb.cloneNode(0):ed.dom.create(bn);aft.removeAttribute('id');if(/^(H[1-6])$/.test(bn)&&isAtEnd(r,sb))
aft=ed.dom.create(se.element);n=sc=sn;do{if(n==b||n.nodeType==9||t.dom.isBlock(n)||/(TD|TABLE|TH|CAPTION)/.test(n.nodeName))
break;sc=n;}while((n=n.previousSibling?n.previousSibling:n.parentNode));n=ec=en;do{if(n==b||n.nodeType==9||t.dom.isBlock(n)||/(TD|TABLE|TH|CAPTION)/.test(n.nodeName))
break;ec=n;}while((n=n.nextSibling?n.nextSibling:n.parentNode));if(sc.nodeName==bn)
rb.setStart(sc,0);else
rb.setStartBefore(sc);rb.setEnd(sn,so);bef.appendChild(rb.cloneContents()||d.createTextNode(''));try{ra.setEndAfter(ec);}catch(ex){}
ra.setStart(en,eo);aft.appendChild(ra.cloneContents()||d.createTextNode(''));r=d.createRange();if(!sc.previousSibling&&sc.parentNode.nodeName==bn){r.setStartBefore(sc.parentNode);}else{if(rb.startContainer.nodeName==bn&&rb.startOffset==0)
r.setStartBefore(rb.startContainer);else
r.setStart(rb.startContainer,rb.startOffset);}
if(!ec.nextSibling&&ec.parentNode.nodeName==bn)
r.setEndAfter(ec.parentNode);else
r.setEnd(ra.endContainer,ra.endOffset);r.deleteContents();if(isOpera)
ed.getWin().scrollTo(0,vp.y);if(bef.firstChild&&bef.firstChild.nodeName==bn)
bef.innerHTML=bef.firstChild.innerHTML;if(aft.firstChild&&aft.firstChild.nodeName==bn)
aft.innerHTML=aft.firstChild.innerHTML;function appendStyles(e,en){var nl=[],nn,n,i;e.innerHTML='';if(se.keep_styles){n=en;do{if(/^(SPAN|STRONG|B|EM|I|FONT|STRIKE|U)$/.test(n.nodeName)){nn=n.cloneNode(FALSE);dom.setAttrib(nn,'id','');nl.push(nn);}}while(n=n.parentNode);}
if(nl.length>0){for(i=nl.length-1,nn=e;i>=0;i--)
nn=nn.appendChild(nl[i]);nl[0].innerHTML=isOpera?'\u00a0':'<br />';return nl[0];}else
e.innerHTML=isOpera?'\u00a0':'<br />';};if(dom.isEmpty(bef))
appendStyles(bef,sn);if(dom.isEmpty(aft))
car=appendStyles(aft,en);if(isOpera&&parseFloat(opera.version())<9.5){r.insertNode(bef);r.insertNode(aft);}else{r.insertNode(aft);r.insertNode(bef);}
aft.normalize();bef.normalize();ed.selection.select(aft,true);ed.selection.collapse(true);y=ed.dom.getPos(aft).y;if(y<vp.y||y+25>vp.y+vp.h){ed.getWin().scrollTo(0,y<vp.y?y:y-vp.h+25);}
ed.undoManager.add();return FALSE;},backspaceDelete:function(e,bs){var t=this,ed=t.editor,b=ed.getBody(),dom=ed.dom,n,se=ed.selection,r=se.getRng(),sc=r.startContainer,n,w,tn,walker;if(!bs&&r.collapsed&&sc.nodeType==1&&r.startOffset==sc.childNodes.length){walker=new tinymce.dom.TreeWalker(sc.lastChild,sc);for(n=sc.lastChild;n;n=walker.prev()){if(n.nodeType==3){r.setStart(n,n.nodeValue.length);r.collapse(true);se.setRng(r);return;}}}
if(sc&&ed.dom.isBlock(sc)&&!/^(TD|TH)$/.test(sc.nodeName)&&bs){if(sc.childNodes.length==0||(sc.childNodes.length==1&&sc.firstChild.nodeName=='BR')){n=sc;while((n=n.previousSibling)&&!ed.dom.isBlock(n));if(n){if(sc!=b.firstChild){w=ed.dom.doc.createTreeWalker(n,NodeFilter.SHOW_TEXT,null,FALSE);while(tn=w.nextNode())
n=tn;r=ed.getDoc().createRange();r.setStart(n,n.nodeValue?n.nodeValue.length:0);r.setEnd(n,n.nodeValue?n.nodeValue.length:0);se.setRng(r);ed.dom.remove(sc);}
return Event.cancel(e);}}}}});})(tinymce);