(function(tinymce){function trimNl(s){return s.replace(/[\n\r]+/g,'');};var is=tinymce.is,isIE=tinymce.isIE,each=tinymce.each;tinymce.create('tinymce.dom.Selection',{Selection:function(dom,win,serializer){var t=this;t.dom=dom;t.win=win;t.serializer=serializer;each(['onBeforeSetContent','onBeforeGetContent','onSetContent','onGetContent'],function(e){t[e]=new tinymce.util.Dispatcher(t);});if(!t.win.getSelection)
t.tridentSel=new tinymce.dom.TridentSelection(t);if(tinymce.isIE&&dom.boxModel)
this._fixIESelection();tinymce.addUnload(t.destroy,t);},setCursorLocation:function(node,offset){var t=this;var r=t.dom.createRng();r.setStart(node,offset);r.setEnd(node,offset);t.setRng(r);t.collapse(false);},getContent:function(s){var t=this,r=t.getRng(),e=t.dom.create("body"),se=t.getSel(),wb,wa,n;s=s||{};wb=wa='';s.get=true;s.format=s.format||'html';s.forced_root_block='';t.onBeforeGetContent.dispatch(t,s);if(s.format=='text')
return t.isCollapsed()?'':(r.text||(se.toString?se.toString():''));if(r.cloneContents){n=r.cloneContents();if(n)
e.appendChild(n);}else if(is(r.item)||is(r.htmlText)){e.innerHTML='<br>'+(r.item?r.item(0).outerHTML:r.htmlText);e.removeChild(e.firstChild);}else
e.innerHTML=r.toString();if(/^\s/.test(e.innerHTML))
wb=' ';if(/\s+$/.test(e.innerHTML))
wa=' ';s.getInner=true;s.content=t.isCollapsed()?'':wb+t.serializer.serialize(e,s)+wa;t.onGetContent.dispatch(t,s);return s.content;},setContent:function(content,args){var self=this,rng=self.getRng(),caretNode,doc=self.win.document,frag,temp;args=args||{format:'html'};args.set=true;content=args.content=content;if(!args.no_events)
self.onBeforeSetContent.dispatch(self,args);content=args.content;if(rng.insertNode){content+='<span id="__caret">_</span>';if(rng.startContainer==doc&&rng.endContainer==doc){doc.body.innerHTML=content;}else{rng.deleteContents();if(doc.body.childNodes.length==0){doc.body.innerHTML=content;}else{if(rng.createContextualFragment){rng.insertNode(rng.createContextualFragment(content));}else{frag=doc.createDocumentFragment();temp=doc.createElement('div');frag.appendChild(temp);temp.outerHTML=content;rng.insertNode(frag);}}}
caretNode=self.dom.get('__caret');rng=doc.createRange();rng.setStartBefore(caretNode);rng.setEndBefore(caretNode);self.setRng(rng);self.dom.remove('__caret');try{self.setRng(rng);}catch(ex){}}else{if(rng.item){doc.execCommand('Delete',false,null);rng=self.getRng();}
if(/^\s+/.test(content)){rng.pasteHTML('<span id="__mce_tmp">_</span>'+content);self.dom.remove('__mce_tmp');}else
rng.pasteHTML(content);}
if(!args.no_events)
self.onSetContent.dispatch(self,args);},getStart:function(){var rng=this.getRng(),startElement,parentElement,checkRng,node;if(rng.duplicate||rng.item){if(rng.item)
return rng.item(0);checkRng=rng.duplicate();checkRng.collapse(1);startElement=checkRng.parentElement();parentElement=node=rng.parentElement();while(node=node.parentNode){if(node==startElement){startElement=parentElement;break;}}
return startElement;}else{startElement=rng.startContainer;if(startElement.nodeType==1&&startElement.hasChildNodes())
startElement=startElement.childNodes[Math.min(startElement.childNodes.length-1,rng.startOffset)];if(startElement&&startElement.nodeType==3)
return startElement.parentNode;return startElement;}},getEnd:function(){var t=this,r=t.getRng(),e,eo;if(r.duplicate||r.item){if(r.item)
return r.item(0);r=r.duplicate();r.collapse(0);e=r.parentElement();if(e&&e.nodeName=='BODY')
return e.lastChild||e;return e;}else{e=r.endContainer;eo=r.endOffset;if(e.nodeType==1&&e.hasChildNodes())
e=e.childNodes[eo>0?eo-1:eo];if(e&&e.nodeType==3)
return e.parentNode;return e;}},getBookmark:function(type,normalized){var t=this,dom=t.dom,rng,rng2,id,collapsed,name,element,index,chr='\uFEFF',styles;function findIndex(name,element){var index=0;each(dom.select(name),function(node,i){if(node==element)
index=i;});return index;};if(type==2){function getLocation(){var rng=t.getRng(true),root=dom.getRoot(),bookmark={};function getPoint(rng,start){var container=rng[start?'startContainer':'endContainer'],offset=rng[start?'startOffset':'endOffset'],point=[],node,childNodes,after=0;if(container.nodeType==3){if(normalized){for(node=container.previousSibling;node&&node.nodeType==3;node=node.previousSibling)
offset+=node.nodeValue.length;}
point.push(offset);}else{childNodes=container.childNodes;if(offset>=childNodes.length&&childNodes.length){after=1;offset=Math.max(0,childNodes.length-1);}
point.push(t.dom.nodeIndex(childNodes[offset],normalized)+after);}
for(;container&&container!=root;container=container.parentNode)
point.push(t.dom.nodeIndex(container,normalized));return point;};bookmark.start=getPoint(rng,true);if(!t.isCollapsed())
bookmark.end=getPoint(rng);return bookmark;};if(t.tridentSel)
return t.tridentSel.getBookmark(type);return getLocation();}
if(type)
return{rng:t.getRng()};rng=t.getRng();id=dom.uniqueId();collapsed=tinyMCE.activeEditor.selection.isCollapsed();styles='overflow:hidden;line-height:0px';if(rng.duplicate||rng.item){if(!rng.item){rng2=rng.duplicate();try{rng.collapse();rng.pasteHTML('<span data-mce-type="bookmark" id="'+id+'_start" style="'+styles+'">'+chr+'</span>');if(!collapsed){rng2.collapse(false);rng.moveToElementText(rng2.parentElement());if(rng.compareEndPoints('StartToEnd',rng2)==0)
rng2.move('character',-1);rng2.pasteHTML('<span data-mce-type="bookmark" id="'+id+'_end" style="'+styles+'">'+chr+'</span>');}}catch(ex){return null;}}else{element=rng.item(0);name=element.nodeName;return{name:name,index:findIndex(name,element)};}}else{element=t.getNode();name=element.nodeName;if(name=='IMG')
return{name:name,index:findIndex(name,element)};rng2=rng.cloneRange();if(!collapsed){rng2.collapse(false);rng2.insertNode(dom.create('span',{'data-mce-type':"bookmark",id:id+'_end',style:styles},chr));}
rng.collapse(true);rng.insertNode(dom.create('span',{'data-mce-type':"bookmark",id:id+'_start',style:styles},chr));}
t.moveToBookmark({id:id,keep:1});return{id:id};},moveToBookmark:function(bookmark){var t=this,dom=t.dom,marker1,marker2,rng,root,startContainer,endContainer,startOffset,endOffset;if(bookmark){if(bookmark.start){rng=dom.createRng();root=dom.getRoot();function setEndPoint(start){var point=bookmark[start?'start':'end'],i,node,offset,children;if(point){offset=point[0];for(node=root,i=point.length-1;i>=1;i--){children=node.childNodes;if(point[i]>children.length-1)
return;node=children[point[i]];}
if(node.nodeType===3)
offset=Math.min(point[0],node.nodeValue.length);if(node.nodeType===1)
offset=Math.min(point[0],node.childNodes.length);if(start)
rng.setStart(node,offset);else
rng.setEnd(node,offset);}
return true;};if(t.tridentSel)
return t.tridentSel.moveToBookmark(bookmark);if(setEndPoint(true)&&setEndPoint()){t.setRng(rng);}}else if(bookmark.id){function restoreEndPoint(suffix){var marker=dom.get(bookmark.id+'_'+suffix),node,idx,next,prev,keep=bookmark.keep;if(marker){node=marker.parentNode;if(suffix=='start'){if(!keep){idx=dom.nodeIndex(marker);}else{node=marker.firstChild;idx=1;}
startContainer=endContainer=node;startOffset=endOffset=idx;}else{if(!keep){idx=dom.nodeIndex(marker);}else{node=marker.firstChild;idx=1;}
endContainer=node;endOffset=idx;}
if(!keep){prev=marker.previousSibling;next=marker.nextSibling;each(tinymce.grep(marker.childNodes),function(node){if(node.nodeType==3)
node.nodeValue=node.nodeValue.replace(/\uFEFF/g,'');});while(marker=dom.get(bookmark.id+'_'+suffix))
dom.remove(marker,1);if(prev&&next&&prev.nodeType==next.nodeType&&prev.nodeType==3&&!tinymce.isOpera){idx=prev.nodeValue.length;prev.appendData(next.nodeValue);dom.remove(next);if(suffix=='start'){startContainer=endContainer=prev;startOffset=endOffset=idx;}else{endContainer=prev;endOffset=idx;}}}}};function addBogus(node){if(dom.isBlock(node)&&!node.innerHTML)
node.innerHTML=!isIE?'<br data-mce-bogus="1" />':' ';return node;};restoreEndPoint('start');restoreEndPoint('end');if(startContainer){rng=dom.createRng();rng.setStart(addBogus(startContainer),startOffset);rng.setEnd(addBogus(endContainer),endOffset);t.setRng(rng);}}else if(bookmark.name){t.select(dom.select(bookmark.name)[bookmark.index]);}else if(bookmark.rng)
t.setRng(bookmark.rng);}},select:function(node,content){var t=this,dom=t.dom,rng=dom.createRng(),idx;if(node){idx=dom.nodeIndex(node);rng.setStart(node.parentNode,idx);rng.setEnd(node.parentNode,idx+1);if(content){function setPoint(node,start){var walker=new tinymce.dom.TreeWalker(node,node);do{if(node.nodeType==3&&tinymce.trim(node.nodeValue).length!=0){if(start)
rng.setStart(node,0);else
rng.setEnd(node,node.nodeValue.length);return;}
if(node.nodeName=='BR'){if(start)
rng.setStartBefore(node);else
rng.setEndBefore(node);return;}}while(node=(start?walker.next():walker.prev()));};setPoint(node,1);setPoint(node);}
t.setRng(rng);}
return node;},isCollapsed:function(){var t=this,r=t.getRng(),s=t.getSel();if(!r||r.item)
return false;if(r.compareEndPoints)
return r.compareEndPoints('StartToEnd',r)===0;return!s||r.collapsed;},collapse:function(to_start){var self=this,rng=self.getRng(),node;if(rng.item){node=rng.item(0);rng=self.win.document.body.createTextRange();rng.moveToElementText(node);}
rng.collapse(!!to_start);self.setRng(rng);},getSel:function(){var t=this,w=this.win;return w.getSelection?w.getSelection():w.document.selection;},getRng:function(w3c){var t=this,s,r,elm,doc=t.win.document;if(w3c&&t.tridentSel)
return t.tridentSel.getRangeAt(0);try{if(s=t.getSel())
r=s.rangeCount>0?s.getRangeAt(0):(s.createRange?s.createRange():doc.createRange());}catch(ex){}
if(tinymce.isIE&&r&&r.setStart&&doc.selection.createRange().item){elm=doc.selection.createRange().item(0);r=doc.createRange();r.setStartBefore(elm);r.setEndAfter(elm);}
if(!r)
r=doc.createRange?doc.createRange():doc.body.createTextRange();if(t.selectedRange&&t.explicitRange){if(r.compareBoundaryPoints(r.START_TO_START,t.selectedRange)===0&&r.compareBoundaryPoints(r.END_TO_END,t.selectedRange)===0){r=t.explicitRange;}else{t.selectedRange=null;t.explicitRange=null;}}
return r;},setRng:function(r){var s,t=this;if(!t.tridentSel){s=t.getSel();if(s){t.explicitRange=r;try{s.removeAllRanges();}catch(ex){}
s.addRange(r);t.selectedRange=s.getRangeAt(0);}}else{if(r.cloneRange){t.tridentSel.addRange(r);return;}
try{r.select();}catch(ex){}}},setNode:function(n){var t=this;t.setContent(t.dom.getOuterHTML(n));return n;},getNode:function(){var t=this,rng=t.getRng(),sel=t.getSel(),elm,start=rng.startContainer,end=rng.endContainer;if(!rng)
return t.dom.getRoot();if(rng.setStart){elm=rng.commonAncestorContainer;if(!rng.collapsed){if(rng.startContainer==rng.endContainer){if(rng.endOffset-rng.startOffset<2){if(rng.startContainer.hasChildNodes())
elm=rng.startContainer.childNodes[rng.startOffset];}}
if(start.nodeType===3&&end.nodeType===3){function skipEmptyTextNodes(n,forwards){var orig=n;while(n&&n.nodeType===3&&n.length===0){n=forwards?n.nextSibling:n.previousSibling;}
return n||orig;}
if(start.length===rng.startOffset){start=skipEmptyTextNodes(start.nextSibling,true);}else{start=start.parentNode;}
if(rng.endOffset===0){end=skipEmptyTextNodes(end.previousSibling,false);}else{end=end.parentNode;}
if(start&&start===end)
return start;}}
if(elm&&elm.nodeType==3)
return elm.parentNode;return elm;}
return rng.item?rng.item(0):rng.parentElement();},getSelectedBlocks:function(st,en){var t=this,dom=t.dom,sb,eb,n,bl=[];sb=dom.getParent(st||t.getStart(),dom.isBlock);eb=dom.getParent(en||t.getEnd(),dom.isBlock);if(sb)
bl.push(sb);if(sb&&eb&&sb!=eb){n=sb;var walker=new tinymce.dom.TreeWalker(sb,dom.getRoot());while((n=walker.next())&&n!=eb){if(dom.isBlock(n))
bl.push(n);}}
if(eb&&sb!=eb)
bl.push(eb);return bl;},normalize:function(){var self=this,rng,normalized;if(tinymce.isIE)
return;function normalizeEndPoint(start){var container,offset,walker,dom=self.dom,body=dom.getRoot(),node;container=rng[(start?'start':'end')+'Container'];offset=rng[(start?'start':'end')+'Offset'];if(container.nodeType===9){container=container.body;offset=0;}
if(container===body){if(container.hasChildNodes()){container=container.childNodes[Math.min(!start&&offset>0?offset-1:offset,container.childNodes.length-1)];offset=0;if(container.hasChildNodes()){node=container;walker=new tinymce.dom.TreeWalker(container,body);do{if(node.nodeType===3){offset=start?0:node.nodeValue.length-1;container=node;break;}
if(node.nodeName==='BR'){offset=dom.nodeIndex(node);container=node.parentNode;break;}}while(node=(start?walker.next():walker.prev()));normalized=true;}}}
if(normalized)
rng['set'+(start?'Start':'End')](container,offset);};rng=self.getRng();normalizeEndPoint(true);if(rng.collapsed)
normalizeEndPoint();if(normalized){self.setRng(rng);}},destroy:function(s){var t=this;t.win=null;if(!s)
tinymce.removeUnload(t.destroy);},_fixIESelection:function(){var dom=this.dom,doc=dom.doc,body=doc.body,started,startRng,htmlElm;doc.documentElement.unselectable=true;function rngFromPoint(x,y){var rng=body.createTextRange();try{rng.moveToPoint(x,y);}catch(ex){rng=null;}
return rng;};function selectionChange(e){var pointRng;if(e.button){pointRng=rngFromPoint(e.x,e.y);if(pointRng){if(pointRng.compareEndPoints('StartToStart',startRng)>0)
pointRng.setEndPoint('StartToStart',startRng);else
pointRng.setEndPoint('EndToEnd',startRng);pointRng.select();}}else
endSelection();}
function endSelection(){var rng=doc.selection.createRange();if(startRng&&!rng.item&&rng.compareEndPoints('StartToEnd',rng)===0)
startRng.select();dom.unbind(doc,'mouseup',endSelection);dom.unbind(doc,'mousemove',selectionChange);startRng=started=0;};dom.bind(doc,['mousedown','contextmenu'],function(e){if(e.target.nodeName==='HTML'){if(started)
endSelection();htmlElm=doc.documentElement;if(htmlElm.scrollHeight>htmlElm.clientHeight)
return;started=1;startRng=rngFromPoint(e.x,e.y);if(startRng){dom.bind(doc,'mouseup',endSelection);dom.bind(doc,'mousemove',selectionChange);dom.win.focus();startRng.select();}}});}});})(tinymce);