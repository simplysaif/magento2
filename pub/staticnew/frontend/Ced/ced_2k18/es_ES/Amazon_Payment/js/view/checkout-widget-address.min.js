define(['jquery','uiComponent','ko','Magento_Customer/js/model/customer','Magento_Checkout/js/model/quote','Magento_Checkout/js/action/select-shipping-address','Magento_Checkout/js/model/shipping-rate-processor/new-address','Magento_Checkout/js/action/set-shipping-information','Amazon_Payment/js/model/storage','Magento_Checkout/js/model/shipping-service','Magento_Checkout/js/model/address-converter','mage/storage','Magento_Checkout/js/model/full-screen-loader','Magento_Checkout/js/model/error-processor','Magento_Checkout/js/model/url-builder','Magento_Checkout/js/checkout-data','Magento_Checkout/js/model/checkout-data-resolver','uiRegistry'],function($,Component,ko,customer,quote,selectShippingAddress,shippingProcessor,setShippingInformationAction,amazonStorage,shippingService,addressConverter,storage,fullScreenLoader,errorProcessor,urlBuilder,checkoutData,checkoutDataResolver,registry){'use strict';var self;return Component.extend({defaults:{template:'Amazon_Payment/checkout-widget-address'},options:{sellerId:registry.get('amazonPayment').merchantId,addressWidgetDOMId:'addressBookWidgetDiv',widgetScope:registry.get('amazonPayment').loginScope},isCustomerLoggedIn:customer.isLoggedIn,isAmazonAccountLoggedIn:amazonStorage.isAmazonAccountLoggedIn,isAmazonEnabled:ko.observable(registry.get('amazonPayment').isPwaEnabled),rates:shippingService.getShippingRates(),initialize:function(){self=this;this._super();},initAddressWidget:function(){self.renderAddressWidget();},renderAddressWidget:function(){new OffAmazonPayments.Widgets.AddressBook({sellerId:self.options.sellerId,scope:self.options.widgetScope,onOrderReferenceCreate:function(orderReference){var orderid=orderReference.getAmazonOrderReferenceId();amazonStorage.setOrderReference(orderid);},onAddressSelect:function(){self.getShippingAddressFromAmazon();},design:{designMode:'responsive'},onError:function(error){console.log(error);}}).bind(self.options.addressWidgetDOMId);},getShippingAddressFromAmazon:function(){var serviceUrl,payload;amazonStorage.isShippingMethodsLoading(true);shippingService.isLoading(true);serviceUrl=urlBuilder.createUrl('/amazon-shipping-address/:amazonOrderReference',{amazonOrderReference:amazonStorage.getOrderReference()}),payload={addressConsentToken:amazonStorage.getAddressConsentToken()};storage.put(serviceUrl,JSON.stringify(payload)).done(function(data){var amazonAddress=data.shift(),addressData=addressConverter.formAddressDataToQuoteAddress(amazonAddress),i;addressData.telephone=!addressData.telephone?'0000000000':addressData.telephone;if($.isArray(addressData.street)){for(i=addressData.street.length;i<=2;i++){addressData.street[i]='';}}
checkoutData.setShippingAddressFromData(addressConverter.quoteAddressToFormAddressData(addressData));checkoutDataResolver.resolveEstimationAddress();}).fail(function(response){errorProcessor.process(response);shippingService.setShippingRates([]);amazonStorage.isShippingMethodsLoading(false);});},getAmazonOrderReference:function(){return amazonStorage.getOrderReference();},getAddressConsentToken:function(){return amazonStorage.getAddressConsentToken();}});});