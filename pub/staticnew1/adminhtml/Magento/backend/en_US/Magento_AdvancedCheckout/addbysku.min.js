define(['prototype','mage/translate','Magento_Catalog/catalog/product/composite/configure'],function(){window.AddBySku=Class.create();AddBySku.prototype={initialize:function(order,data){var originConfiguredCheck,originRequestConfiguration;if(!data){data={};}
this.lastId=0;this.configuredSkus=[];this.configurableItems={};this.dataContainerId=data.dataContainerId;this.deleteButtonHtml=data.deleteButtonHtml;this.order=order;this.listType=data.listType;this.errorGridId=data.errorGridId;this.fileFieldName=data.fileFieldName;this.fileUploadUrl=data.fileUploadUrl;this.fileUploadedParamName=data.fileUploaded;productConfigure.skuObject=this;originConfiguredCheck=productConfigure.itemConfigured;productConfigure.itemConfigured=function(listType,itemId){var indexOfItemId;if(listType!=this.skuObject.listType){return originConfiguredCheck.apply(this,[listType,itemId]);}
indexOfItemId=this.skuObject.configuredSkus.indexOf(itemId);if(indexOfItemId!==-1){if(!originConfiguredCheck.apply(this,[listType,itemId])){this.skuObject.configuredSkus.splice(indexOfItemId,1);return false;}
return true;}
return false;};originRequestConfiguration=productConfigure._requestItemConfiguration;productConfigure._requestItemConfiguration=function(listType,itemId){if(listType==this.skuObject.listType){itemId=this.skuObject.configurableItems[itemId];}
return originRequestConfiguration.apply(this,[listType,itemId]);};function adminSalesInstance(addBySkuObject){var fields,i;this.skuInstance=addBySkuObject;this.order=addBySkuObject.order;this.submitConfigured=function(){};this.updateErrorGrid=function(){};this.onSubmitSkuForm=function(){};fields=$$('#'+addBySkuObject.dataContainerId+' input[name="sku"]','#'+addBySkuObject.dataContainerId+' input[name="qty"]');for(i=0;i<fields.length;i++){Event.observe(fields[i],'keypress',addBySkuObject.formKeyPress.bind(addBySkuObject));}}
adminCheckout.prototype=new adminSalesInstance(this);adminCheckout.prototype.constructor=adminCheckout;function adminCheckout(){this.controllerRequestParameterNames={customerId:'customer',storeId:'store'};}
adminCheckout.prototype.submitConfigured=function(){var oldSourceGrids=this.order.sourceGrids,parentResponseHandler;this.order.sourceGrids={'sku_errors':this.skuInstance.errorSourceGrid};parentResponseHandler=this.order.loadAreaResponseHandler;this.order.loadAreaResponseHandler=function(response){if(!response.errors){response.errors='<span></span>';}
parentResponseHandler.call(this,response);};this.order.productGridAddSelected('sku');this.order.sourceGrids=oldSourceGrids;};adminCheckout.prototype.updateErrorGrid=function(params){var oldLoadingAreas=this.order.loadingAreas,url;this.order.loadingAreas='errors';url=this.order.loadBaseUrl+'block/'+this.skuInstance.listType;if(!params.json){params.json=true;}
new Ajax.Request(url,{parameters:this.order.prepareParams(params),loaderArea:'html-body',onSuccess:function(transport){var response=transport.responseText.evalJSON();if(!response.errors){response.errors='<span></span>';}
this.loadAreaResponseHandler(response);}.bind(this.order),onComplete:function(){this.loadingAreas=oldLoadingAreas;}.bind(this.order)});};adminOrder.prototype=new adminSalesInstance(this);adminOrder.prototype.constructor=adminOrder;function adminOrder(){var skuAreaId=this.order.getAreaId('additional_area');this.controllerRequestParameterNames={customerId:'customerId',storeId:'storeId'};this.order.itemsArea.skuButton=new ControlButton(jQuery.mage.__('Add Products By SKU'));this.order.itemsArea.skuButton.onClick=function(){$(skuAreaId).show();var el=this;window.setTimeout(function(){el.remove();},10);};this.order.itemsArea.onLoad=this.order.itemsArea.onLoad.wrap(function(proceed){proceed();if(!$(skuAreaId).visible()){this.addControlButton(this.skuButton);}});this.order.dataArea.onLoad();}
adminOrder.prototype.submitConfigured=function(){var area=['errors','search','items','shipping_method','totals','giftmessage','billing_method'],table=$('sku_errors_table'),elements=table.select('input[type=checkbox][name=sku_errors]:checked'),fieldsPrepare={};fieldsPrepare['from_error_grid']='1';elements.each(function(elem){var tr;if(!elem.value||elem.value=='on'){return;}
tr=elem.up('tr');if(tr){(function(fieldNames,parent,id){var i,el,paramKey;if(typeof fieldNames=='string'){fieldNames=[fieldNames];}
for(i=0;i<fieldNames.length;i++){el=parent.select('input[name='+fieldNames[i]+']');paramKey='add_by_sku['+id+']['+fieldNames[i]+']';if(el.length){fieldsPrepare[paramKey]=el[0].value;}}})(['qty','sku'],tr,elem.value);}});this.order.productConfigureSubmit('errors',area,fieldsPrepare,this.skuInstance.configuredSkus);this.skuInstance.configuredSkus=[];};adminOrder.prototype.updateErrorGrid=function(params){this.order.loadArea('errors',true,params);};adminOrder.prototype.onSubmitSkuForm=function(){this.order.additionalAreaButton&&Element.show(this.order.additionalAreaButton);this.order.itemsArea.addControlButton(this.order.itemsArea.skuButton);};if(this.order instanceof(window.AdminOrder||Function)){this._provider=new adminOrder();}else{this._provider=new adminCheckout();}
this.controllerRequestParameterNames=this._provider.controllerRequestParameterNames;},removeFailedItem:function(obj){var sku;try{sku=obj.up('tr').select('td')[0].select('input[name="sku"]')[0].value;this._provider.updateErrorGrid({'remove_sku':sku});}catch(e){return false;}},removeAllFailed:function(){this._provider.updateErrorGrid({'sku_remove_failed':'1'});},submitConfigured:function(){this._provider.submitConfigured();},del:function(obj){var tr=obj.up('tr'),itemId,newElement;if($('id_'+tr.id)){itemId=$('id_'+tr.id).value;newElement=document.createElement('input');newElement.type='hidden';newElement.value=itemId;newElement.name='deleteSku[]';$(this.dataContainerId).appendChild(newElement);}
tr.remove();},submitSkuForm:function(){var $form,$file,requestParams,sku,i;this._provider.onSubmitSkuForm();this.order.hideArea&&this.order.hideArea('additional_area');$form=new Element('form',{'action':this.fileUploadUrl,'method':'post','enctype':'multipart/form-data'});$form.insert(new Element('input',{'type':'hidden','name':this.fileUploadedParamName,'value':'0'}));$file=Element.select('body','input[name="'+this.fileFieldName+'"]')[0];if($file.value){$file.up().insert(new Element('input',{'type':'file','name':this.fileFieldName}));$form.insert($file);$form[this.fileUploadedParamName].value='1';}
requestParams={};sku='';$('sku_table').select('input[type=text]').each(function(elem){var qty=0,paramKey;if(elem.name=='sku'){sku=elem.value;}else if(elem.name=='qty'){qty=elem.value;}else{return;}
if(sku!=''){paramKey='add_by_sku['+sku+'][qty]';if(paramKey in requestParams){requestParams[paramKey]=parseNumber(requestParams[paramKey])+parseNumber(qty);}else{requestParams[paramKey]=qty;}}});if(!Object.keys(requestParams).length&&!$file.value){return false;}
for(i in requestParams){$form.insert(new Element('input',{'type':'hidden','name':i,'value':requestParams[i]}));}
$form.insert(new Element('input',{'type':'hidden','name':this.controllerRequestParameterNames.customerId,'value':this.order.customerId}));$form.insert(new Element('input',{'type':'hidden','name':this.controllerRequestParameterNames.storeId,'value':this.order.storeId}));$form.insert(new Element('input',{'type':'hidden','name':'form_key','value':FORM_KEY}));Element.select(document,'body')[0].insert($form);$form.submit();jQuery($form).trigger('processStart');return true;},configure:function(id,sku){var productRow=$('sku_errors_table').select('div[id=sku_'+sku+']')[0],noticeElement=productRow.select('.notice'),productQtyElement=productRow.up('tr').select('input[name=qty]')[0];if(typeof this.configurableItems[sku]==='undefined'){this.configurableItems[sku]=id;}
productConfigure.setConfirmCallback(this.listType,function(){var $qty;productConfigure.skuObject.configuredSkus.push(sku.toString());if(noticeElement.length){noticeElement[0].remove();}
$qty=productConfigure.getCurrentConfirmedQtyElement();if($qty){productQtyElement.value=$qty.value;}});productConfigure.showItemConfiguration(this.listType,sku);productConfigure.setShowWindowCallback(this.listType,function(){var qty=productQtyElement.value,formCurrentQty;if(qty&&!isNaN(qty)){formCurrentQty=productConfigure.getCurrentFormQtyElement();if(formCurrentQty){formCurrentQty.value=qty;}}});},observeAddToCart:function(){var that=this;this.addToCartButtonEvents=[];$('products_search').select('button.button-to-cart').each(function(button){that.addToCartButtonEvents[button.id]=button.onclick;button.onclick=function(){that.submitSkuForm()||that.addToCartButtonEvents[this.id]();that.clearAddForm();};});},clearAddForm:function(){var $rows=$(this.dataContainerId).select('tr'),rowNum=$rows.length,i;for(i=1;i<rowNum;i++){$rows[i].remove();}
$rows[0].select('input[name="sku"]')[0].value='';$rows[0].select('input[name="qty"]')[0].value='';},addErrorSourceGrid:function(params){this.errorSourceGrid=params;},formKeyPress:function(event){if(event.keyCode==Event.KEY_RETURN){this.submitSkuForm();}
return false;}};});