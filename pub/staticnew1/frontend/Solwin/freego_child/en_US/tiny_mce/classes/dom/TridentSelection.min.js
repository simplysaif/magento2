(function(){function Selection(selection){var self=this,dom=selection.dom,TRUE=true,FALSE=false;function getPosition(rng,start){var checkRng,startIndex=0,endIndex,inside,children,child,offset,index,position=-1,parent;checkRng=rng.duplicate();checkRng.collapse(start);parent=checkRng.parentElement();if(parent.ownerDocument!==selection.dom.doc)
return;while(parent.contentEditable==="false"){parent=parent.parentNode;}
if(!parent.hasChildNodes()){return{node:parent,inside:1};}
children=parent.children;endIndex=children.length-1;while(startIndex<=endIndex){index=Math.floor((startIndex+endIndex)/ 2);child=children[index];checkRng.moveToElementText(child);position=checkRng.compareEndPoints(start?'StartToStart':'EndToEnd',rng);if(position>0){endIndex=index-1;}else if(position<0){startIndex=index+1;}else{return{node:child};}}
if(position<0){if(!child){checkRng.moveToElementText(parent);checkRng.collapse(true);child=parent;inside=true;}else
checkRng.collapse(false);checkRng.setEndPoint(start?'EndToStart':'EndToEnd',rng);if(checkRng.compareEndPoints(start?'StartToStart':'StartToEnd',rng)>0){checkRng=rng.duplicate();checkRng.collapse(start);offset=-1;while(parent==checkRng.parentElement()){if(checkRng.move('character',-1)==0)
break;offset++;}}
offset=offset||checkRng.text.replace('\r\n',' ').length;}else{checkRng.collapse(true);checkRng.setEndPoint(start?'StartToStart':'StartToEnd',rng);offset=checkRng.text.replace('\r\n',' ').length;}
return{node:child,position:position,offset:offset,inside:inside};};function getRange(){var ieRange=selection.getRng(),domRange=dom.createRng(),element,collapsed,tmpRange,element2,bookmark,fail;element=ieRange.item?ieRange.item(0):ieRange.parentElement();if(element.ownerDocument!=dom.doc)
return domRange;collapsed=selection.isCollapsed();if(ieRange.item){domRange.setStart(element.parentNode,dom.nodeIndex(element));domRange.setEnd(domRange.startContainer,domRange.startOffset+1);return domRange;}
function findEndPoint(start){var endPoint=getPosition(ieRange,start),container,offset,textNodeOffset=0,sibling,undef,nodeValue;container=endPoint.node;offset=endPoint.offset;if(endPoint.inside&&!container.hasChildNodes()){domRange[start?'setStart':'setEnd'](container,0);return;}
if(offset===undef){domRange[start?'setStartBefore':'setEndAfter'](container);return;}
if(endPoint.position<0){sibling=endPoint.inside?container.firstChild:container.nextSibling;if(!sibling){domRange[start?'setStartAfter':'setEndAfter'](container);return;}
if(!offset){if(sibling.nodeType==3)
domRange[start?'setStart':'setEnd'](sibling,0);else
domRange[start?'setStartBefore':'setEndBefore'](sibling);return;}
while(sibling){nodeValue=sibling.nodeValue;textNodeOffset+=nodeValue.length;if(textNodeOffset>=offset){container=sibling;textNodeOffset-=offset;textNodeOffset=nodeValue.length-textNodeOffset;break;}
sibling=sibling.nextSibling;}}else{sibling=container.previousSibling;if(!sibling)
return domRange[start?'setStartBefore':'setEndBefore'](container);if(!offset){if(container.nodeType==3)
domRange[start?'setStart':'setEnd'](sibling,container.nodeValue.length);else
domRange[start?'setStartAfter':'setEndAfter'](sibling);return;}
while(sibling){textNodeOffset+=sibling.nodeValue.length;if(textNodeOffset>=offset){container=sibling;textNodeOffset-=offset;break;}
sibling=sibling.previousSibling;}}
domRange[start?'setStart':'setEnd'](container,textNodeOffset);};try{findEndPoint(true);if(!collapsed)
findEndPoint();}catch(ex){if(ex.number==-2147024809){bookmark=self.getBookmark(2);tmpRange=ieRange.duplicate();tmpRange.collapse(true);element=tmpRange.parentElement();if(!collapsed){tmpRange=ieRange.duplicate();tmpRange.collapse(false);element2=tmpRange.parentElement();element2.innerHTML=element2.innerHTML;}
element.innerHTML=element.innerHTML;self.moveToBookmark(bookmark);ieRange=selection.getRng();findEndPoint(true);if(!collapsed)
findEndPoint();}else
throw ex;}
return domRange;};this.getBookmark=function(type){var rng=selection.getRng(),start,end,bookmark={};function getIndexes(node){var node,parent,root,children,i,indexes=[];parent=node.parentNode;root=dom.getRoot().parentNode;while(parent!=root&&parent.nodeType!==9){children=parent.children;i=children.length;while(i--){if(node===children[i]){indexes.push(i);break;}}
node=parent;parent=parent.parentNode;}
return indexes;};function getBookmarkEndPoint(start){var position;position=getPosition(rng,start);if(position){return{position:position.position,offset:position.offset,indexes:getIndexes(position.node),inside:position.inside};}};if(type===2){if(!rng.item){bookmark.start=getBookmarkEndPoint(true);if(!selection.isCollapsed())
bookmark.end=getBookmarkEndPoint();}else
bookmark.start={ctrl:true,indexes:getIndexes(rng.item(0))};}
return bookmark;};this.moveToBookmark=function(bookmark){var rng,body=dom.doc.body;function resolveIndexes(indexes){var node,i,idx,children;node=dom.getRoot();for(i=indexes.length-1;i>=0;i--){children=node.children;idx=indexes[i];if(idx<=children.length-1){node=children[idx];}}
return node;};function setBookmarkEndPoint(start){var endPoint=bookmark[start?'start':'end'],moveLeft,moveRng,undef;if(endPoint){moveLeft=endPoint.position>0;moveRng=body.createTextRange();moveRng.moveToElementText(resolveIndexes(endPoint.indexes));offset=endPoint.offset;if(offset!==undef){moveRng.collapse(endPoint.inside||moveLeft);moveRng.moveStart('character',moveLeft?-offset:offset);}else
moveRng.collapse(start);rng.setEndPoint(start?'StartToStart':'EndToStart',moveRng);if(start)
rng.collapse(true);}};if(bookmark.start){if(bookmark.start.ctrl){rng=body.createControlRange();rng.addElement(resolveIndexes(bookmark.start.indexes));rng.select();}else{rng=body.createTextRange();setBookmarkEndPoint(true);setBookmarkEndPoint();rng.select();}}};this.addRange=function(rng){var ieRng,ctrlRng,startContainer,startOffset,endContainer,endOffset,doc=selection.dom.doc,body=doc.body;function setEndPoint(start){var container,offset,marker,tmpRng,nodes;marker=dom.create('a');container=start?startContainer:endContainer;offset=start?startOffset:endOffset;tmpRng=ieRng.duplicate();if(container==doc||container==doc.documentElement){container=body;offset=0;}
if(container.nodeType==3){container.parentNode.insertBefore(marker,container);tmpRng.moveToElementText(marker);tmpRng.moveStart('character',offset);dom.remove(marker);ieRng.setEndPoint(start?'StartToStart':'EndToEnd',tmpRng);}else{nodes=container.childNodes;if(nodes.length){if(offset>=nodes.length){dom.insertAfter(marker,nodes[nodes.length-1]);}else{container.insertBefore(marker,nodes[offset]);}
tmpRng.moveToElementText(marker);}else{marker=doc.createTextNode('\uFEFF');container.appendChild(marker);tmpRng.moveToElementText(marker.parentNode);tmpRng.collapse(TRUE);}
ieRng.setEndPoint(start?'StartToStart':'EndToEnd',tmpRng);dom.remove(marker);}}
startContainer=rng.startContainer;startOffset=rng.startOffset;endContainer=rng.endContainer;endOffset=rng.endOffset;ieRng=body.createTextRange();if(startContainer==endContainer&&startContainer.nodeType==1&&startOffset==endOffset-1){if(startOffset==endOffset-1){try{ctrlRng=body.createControlRange();ctrlRng.addElement(startContainer.childNodes[startOffset]);ctrlRng.select();return;}catch(ex){}}}
setEndPoint(true);setEndPoint();ieRng.select();};this.getRangeAt=getRange;};tinymce.dom.TridentSelection=Selection;})();